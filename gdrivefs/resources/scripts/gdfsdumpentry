#!/usr/bin/env python2.7

import sys
import os.path
dev_path = os.path.abspath(os.path.join(os.path.dirname(__file__), '..'))
sys.path.insert(0, dev_path)

import logging
import argparse

import gdrivefs.config.log
import gdrivefs.cache.volume
import gdrivefs.gdfs.fsutility
import gdrivefs.gdfs.gdfuse
import gdrivefs.timer
import gdrivefs.errors

_logger = logging.getLogger(__name__)

def _get_by_path(raw_path):
    try:
        result = gdrivefs.gdfs.fsutility.split_path(raw_path, gdrivefs.cache.volume.path_resolver)
        (parent_clause, path, filename, mime_type, is_hidden) = result
    except:
        print("Could not process file-path [%s]." % (raw_path))
        sys.exit()

    filepath = gdrivefs.gdfs.fsutility.build_filepath(path, filename)
    
    path_relations = gdrivefs.cache.volume.PathRelations.get_instance()

    try:
        entry_clause = path_relations.get_clause_from_path(filepath)
    except gdrivefs.errors.GdNotFoundError:
        print("Could not retrieve clause for non-existent file-path [%s]." % 
              (filepath))
        sys.exit()
    except:
        print("Could not retrieve clause for path [%s]. " % (filepath))
        sys.exit()

    if not entry_clause:
        print("Path [%s] does not exist for stat()." % (filepath))
        sys.exit()

    return entry_clause[gdrivefs.cache.volume.CLAUSE_ENTRY]

def _get_by_id(_id):
    cache = gdrivefs.cache.volume.EntryCache.get_instance().cache

    return cache.get(_id)

def main():
    parser = argparse.ArgumentParser()
    parser.add_argument('cred_filepath', help='Credentials file')

    subparsers = parser.add_subparsers(help='subcommand help')
    parser_bypath = subparsers.add_parser('bypath', help='Path-based lookups.')
    parser_bypath.add_argument('path', help='Path to identify')
    parser_byid = subparsers.add_parser('byid', help='Path-based lookups.')
    parser_byid.add_argument('id', help='Specific entry to identify')

    args = parser.parse_args()

    gdrivefs.gdfs.gdfuse.set_auth_cache_filepath(args.cred_filepath)
    gdrivefs.timer.Timers.get_instance().set_autostart_default(False)

    if 'id' in args:
        entry = _get_by_id(args.id)
    
    if 'path' in args:
        entry = _get_by_path(args.path)

    print(entry)
    print    

    data = entry.get_data()

    for _type, _dict in data.iteritems():
        print("[%s]\n" % (_type))

        for key, value in _dict.iteritems():
            print("%s: %s" % (key, value))

        print

if __name__ == '__main__':
    main()
